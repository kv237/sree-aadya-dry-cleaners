<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Profile & Settings | Sree Aadya Dry Cleaners</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
body { margin:0; font-family:"Poppins",sans-serif; background:#f4f7fb; color:#333; }
.sidebar { width:250px; background:#0b0c10; color:#fff; position:fixed; height:100%; padding-top:40px; transition:0.3s; }
.sidebar h2 { text-align:center; color:#42a5f5; font-size:24px; margin-bottom:40px; }
.sidebar a { display:block; padding:14px 25px; color:#ddd; text-decoration:none; transition:0.3s; }
.sidebar a:hover, .sidebar a.active { background:#42a5f5; color:#fff; }
.main-content { margin-left:250px; padding:50px 60px; transition:0.3s; }
.profile-header { display:flex; flex-wrap:wrap; align-items:center; gap:25px; background:#fff; padding:30px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.1); margin-bottom:30px; }
.profile-img { position:relative; width:120px; height:120px; }
.profile-img img { width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid #42a5f5; }
.tabs { display:flex; flex-wrap:wrap; gap:20px; margin-bottom:25px; }
.tab { background:#fff; padding:12px 25px; border-radius:10px; cursor:pointer; font-weight:500; box-shadow:0 3px 10px rgba(0,0,0,0.1); color:#555; transition:0.3s; }
.tab.active { background:#42a5f5; color:#fff; }
.section { display:none; background:#fff; padding:30px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
.section.active { display:block; }
.profile-item { display:flex; flex-wrap:wrap; justify-content:space-between; border-bottom:1px solid #eee; padding:15px 0; }
.profile-item:last-child { border-bottom:none; }
.profile-item span { font-weight:500; margin-bottom:5px; display:block; }
.profile-item input { border:none; outline:none; font-size:15px; color:#555; width:60%; background:transparent; min-width:150px; }
.btn-group { margin-top:20px; text-align:right; width:100%; }
button { border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; transition:0.3s; }
.edit-btn { background:#42a5f5; color:white; }
.save-btn { background:#00c853; color:white; display:none; }
.edit-btn:hover { background:#1e88e5; }
.save-btn:hover { background:#00a043; }
.notification { position:fixed; top:20px; right:20px; background:#42a5f5; color:#fff; padding:15px 20px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.1); display:none; z-index:9999; }
@media (max-width:768px){
  .sidebar { width:60px; padding-top:20px; }
  .sidebar h2 { display:none; }
  .sidebar a { padding:12px; font-size:14px; }
  .main-content { margin-left:60px; padding:30px 20px; }
  .profile-item input { width:100%; }
  .profile-header { flex-direction:column; align-items:center; text-align:center; }
}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Sree Aadya</h2>
  <a href="dashboard.html"><i class="fas fa-home"></i></a>
  <a href="myorders.html"><i class="fas fa-tshirt"></i></a>
  <a href="delivery.html"><i class="fas fa-truck"></i></a>
  <a href="profile.html" class="active"><i class="fas fa-user"></i></a>
  <a href="contact.html"><i class="fas fa-headset"></i></a>
  <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></a>
</div>

<div class="main-content">
  <div class="profile-header">
    <div class="profile-img">
      <img id="profileImage" src="https://via.placeholder.com/120" alt="Profile Picture" />
    </div>
    <div class="profile-info">
      <h1 id="profileName">Loading...</h1>
      <p id="profileEmail">Loading...</p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-section="profile">Profile</div>
    <div class="tab" data-section="delivery">Delivery Address</div>
  </div>

  <!-- Profile Section -->
  <div id="profile" class="section active">
    <div class="profile-item"><span>Full Name:</span><input type="text" id="name" disabled></div>
    <div class="profile-item"><span>Email Address:</span><input type="text" id="email" disabled></div>
    <div class="profile-item"><span>Phone Number:</span><input type="text" id="phone" disabled></div>
    <div class="profile-item"><span>Member Since:</span><input type="text" id="joinedDate" disabled></div>
    <div class="btn-group">
      <button class="edit-btn" id="editBtn">Edit Profile</button>
      <button class="save-btn" id="saveBtn">Save Changes</button>
    </div>
  </div>

  <!-- Delivery Section -->
  <div id="delivery" class="section">
    <div class="profile-item"><span>Address:</span><input type="text" id="address" disabled></div>
    <div class="profile-item"><span>City:</span><input type="text" id="city" disabled></div>
    <div class="profile-item"><span>Pincode:</span><input type="text" id="pincode" disabled></div>
    <div class="profile-item"><span>Landmark:</span><input type="text" id="landmark" disabled></div>
    <div class="btn-group">
      <button class="edit-btn" id="editDeliveryBtn">Edit Address</button>
      <button class="save-btn" id="saveDeliveryBtn">Save Address</button>
    </div>
  </div>

</div>

<div class="notification" id="notification"></div>

<script>
const API_BASE = "http://localhost:5000";
let userData = JSON.parse(localStorage.getItem("user"));
if(!userData){ alert("Please login first"); window.location.href="login.html"; }

// Notification
function showNotification(msg, color="#42a5f5"){
  const notif = document.getElementById("notification");
  notif.textContent = msg;
  notif.style.background = color;
  notif.style.display = "block";
  setTimeout(()=> notif.style.display="none", 3000);
}

// Tab switching
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.section).classList.add("active");
  };
});

// Load user data
async function loadUserData(){
  try{
    const res = await fetch(`${API_BASE}/login`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ email: userData.email, password: userData.password || "" })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.message || "Failed to fetch user");
    const user = data.user;

    // Profile
    document.getElementById("name").value = user.name || "";
    document.getElementById("email").value = user.email || "";
    document.getElementById("phone").value = user.phone || "";
    document.getElementById("joinedDate").value = user.joined ? new Date(user.joined).toLocaleDateString() : "";
    document.getElementById("profileName").textContent = user.name || "User";
    document.getElementById("profileEmail").textContent = user.email || "";
    document.getElementById("profileImage").src = user.image || "https://via.placeholder.com/120";

    // Delivery
    document.getElementById("address").value = user.address || "";
    document.getElementById("city").value = user.city || "";
    document.getElementById("pincode").value = user.pincode || "";
    document.getElementById("landmark").value = user.landmark || "";

    userData = user;
    localStorage.setItem("user", JSON.stringify(userData));

  } catch(err){
    console.error(err);
    showNotification("Failed to load user data", "#c62828");
  }
}

// Edit/Save Profile
const profileInputs = document.querySelectorAll("#profile input[type='text']");
document.getElementById("editBtn").onclick = ()=>{
  profileInputs.forEach(i=>i.disabled=false);
  document.getElementById("editBtn").style.display="none";
  document.getElementById("saveBtn").style.display="inline-block";
};
document.getElementById("saveBtn").onclick = async ()=>{
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  if(!name || !email || !phone){ showNotification("All fields required!", "#c62828"); return; }

  try{
    const res = await fetch(`${API_BASE}/api/updateUser`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ uid: userData._id, name, email, phone })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.message || "Update failed");
    showNotification("Profile updated successfully!", "#00c853");
    profileInputs.forEach(i=>i.disabled=true);
    document.getElementById("editBtn").style.display="inline-block";
    document.getElementById("saveBtn").style.display="none";

    userData = {...userData, name, email, phone};
    localStorage.setItem("user", JSON.stringify(userData));
    loadUserData();
  } catch(err){
    console.error(err);
    showNotification("Failed to update profile", "#c62828");
  }
};

// Edit/Save Delivery
const deliveryInputs = ["address","city","pincode","landmark"].map(id=>document.getElementById(id));
document.getElementById("editDeliveryBtn").onclick = ()=>{
  deliveryInputs.forEach(i=>i.disabled=false);
  document.getElementById("editDeliveryBtn").style.display="none";
  document.getElementById("saveDeliveryBtn").style.display="inline-block";
};
document.getElementById("saveDeliveryBtn").onclick = async ()=>{
  const [address, city, pincode, landmark] = deliveryInputs.map(i=>i.value.trim());
  if(!address || !city || !pincode){ showNotification("Address, City, Pincode required!", "#c62828"); return; }

  try{
    const res = await fetch(`${API_BASE}/api/updateUser`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ uid: userData._id, address, city, pincode, landmark })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.message || "Update failed");
    showNotification("Delivery address updated!", "#00c853");
    deliveryInputs.forEach(i=>i.disabled=true);
    document.getElementById("editDeliveryBtn").style.display="inline-block";
    document.getElementById("saveDeliveryBtn").style.display="none";

    userData = {...userData, address, city, pincode, landmark};
    localStorage.setItem("user", JSON.stringify(userData));
    loadUserData();
  } catch(err){
    console.error(err);
    showNotification("Failed to update address", "#c62828");
  }
};

// Logout
document.getElementById("logoutBtn").onclick = ()=>{
  localStorage.removeItem("user");
  showNotification("Logged out successfully!");
  setTimeout(()=> window.location.href="login.html", 500);
};

// Load data on page load
loadUserData();
</script>
</body>
</html>
